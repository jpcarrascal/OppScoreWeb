<!DOCTYPE html>
    <head>
        <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
        <script src="https://d3js.org/d3.v4.js"></script>
        <!-- Google Analytics -->
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-15242862-11"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-15242862-11');
        </script>
    <!-- End Google Analytics -->
        <script type="module">
            import {csvParse} from "https://cdn.skypack.dev/d3-dsv@3";
        </script>
        <script src="saveSvgAsPng.js"></script> <!--- From: https://github.com/exupero/saveSvgAsPng -->
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
                display: flex;
                flex-direction: row;
                justify-content: center;
                background-color:lightgray;
            }
            #wrapper {
                width: 1000px;
                background-color: white;
                padding: 30px;
            }
            #container, #output-container {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                margin-top: 20px;
            }
            .input-buttons {
                margin-top: 10px;
                display: flex;
                flex-direction: row;
            }
            button, .button-ref {
                flex-grow: 1;
                margin: 2px;
                font-size: 1em;
                color: white;
                background-color: #5599EE;
            }
            #controls {
                display: flex;
                flex-direction: column;
            }
            #data-wrapper {
                padding: 0;
                border: 1px solid darkgray;
                width: 500px;
                height: 300px;
                overflow: auto;
            }
            #input-container {
                margin: 0;
            }
            #input-data {
                margin: 0;
                border: 1px solid darkgray;
                padding: 0;
                width: 500px;
                height: 100px;
                white-space: nowrap;
                overflow: auto;
                resize: none;
            }
            #input-table, th {
                margin: 0;
                border: 1px solid darkgray;
                border-collapse: collapse;
            }
            th, td {
                padding-left: 10px;
                padding-right: 10px;
            }
            #input-table {
                width: 500px;
            }
            #additional-info {
                padding: 20px;
            }
            #oppscores-table {
                width:auto;
                border: 1px solid black;
                border-collapse: collapse;
                margin-top: 10px;
            }
            #oppscores-table th {
                border: 1px solid black;
            }
            #oppscores-table td {
                border: 0.5px solid darkgray;
            }
            td {
                font-family: monospace;
            }
            .important {
                font-style: italic;
            }
            #footer {
                width: 100%;
                margin-top: 20px;
                text-align: right;
            }
            .big-red {
                font-size: 2em;
                color: red;
                padding-top: -5px;
                padding-bottom: -5px;
            }
            .hidden-button {
                visibility: hidden;
            }
            .ext-info {
                font-style: italic;
            }
            #status {
                color: red;
            }

            #alt-open {
                color:#5599EE;
                font-weight: bold;
                cursor: pointer;
            }

            #alt-open:hover {
                text-decoration: underline;
            }

            #alt-open:active {
                color: black;
            }

            #alt-modal {
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                position: absolute;
                width: 700px;
                padding: 30px;
                background-color: #DDD;
                top: 50px;
                box-shadow: rgba(0,0,0,0.3) 15px 15px;
            }

            #alt-data {
                width: 80%;
                resize: none;
                margin: 20px;
                overflow: scroll;
                word-wrap: unset;
            }

            #alt-message {
                color: red;
            }

            #alt-close {
                position: absolute;
                top: 8px;
                right: 18px;
                font-size: 1.5em;
                user-select: none;
            }

            #alt-close:hover {
                color: #5599EE;
            }

            .emph {
                text-decoration: underline;
            }

            #output-log {
                font-family: monospace;
                border: 1px solid darkgray;
            }

        </style>
    </head>
    <body>
        <div id="alt-modal">
            <div id="alt-close">✕</div>
            <div>
                <h3>Are your data coming from a survey tool?</h3>
                <ul>
                    <li>Paste your <span class="emph">tab-separated</span> data below.</li>
                    <li>Each row should be a response</li>
                    <li>Columns contain <b>importance</b> and <b>satisfaction</b> for each outcome.</li>
                    This means that each outcome appears in <i>two</i> columns.

                </ul>
                <br />
                Qualtrics and Survey Monkey exports should be almost ready to go.
                just make sure you add 'importance' and 'satisfaction' to each column (first row of your data).
                <br />
                (Sample data included for you to play around with)
            </div>
            <textarea id="alt-data" rows="20" cols="70" wrap="off"></textarea>
            <div class="input-buttons">
                <button id="alt-clear">Clear data</button>
                <button id="alt-reformat">Reformat data</button>
            </div>
            <div id="alt-message">&nbsp;</div>
        </div>
        <div id="wrapper">
            <h2>Opportunity Score and Map Generator (beta)</h2>
            <h3>Input data</h3>
            <ul>
                <li>Import a CSV file that includes <span class="important">these 3 columns <b>[outcome, importance, satisfaction]</b></span>,<br/>or</li>
                <li>paste <span class="emph">tab-separated</span> data formatted in <span class="important">3 columns <b>[outcome, importance, satisfaction]</b></span></li>
                <li><b>importance</b> and <b>satisfaction</b> should be in a 1-5 scale (1=low importance/5=high importance; 1=low satisfaction/5=high satisfaction).</b></span></li>
                <li>If your data is in a different format (e.g. output from a survey tool), <span id="alt-open">click here</span> for more options.</li>
            </ul>
            <div id="container">
                <div id="controls">
                    <input type="file" id="file-selector" accept=".csv" single />
                    <p id="status"> </p>
                    <div id="input-container">
                        <table id="input-table">
                            <tr>
                                <th>outcome</th>
                                <th>importance</th>
                                <th>satisfaction</th>
                            </tr>
                        </table>
    
                        <textarea id="input-data" placeholder="Paste tab or comma-separated data here"></textarea>
                    </div>
                    <div class="input-buttons">
                        <button class="map-data">Map data</button>
                        <button id="clear">Clear data</button>
                    </div>
                </div>
                <div id="additional-info">
                    <br />
                    <br />
                    <br />
                    &larr; Sample data has been included for you to play around with. Click [Clear data] to enter your own data.<br /><br />
                    For more information about the Opportunity Score and Map, check <a href="https://medium.com/uxr-microsoft/what-is-the-opportunity-score-and-how-to-obtain-it-bb81fcbf79b7" target="_blank">this blog post</a>.
                    <br />
                    <br />
                    This an open-source tool, currently in beta. Please file issues or bugs in the <a href="https://github.com/jpcarrascal/OppScoreWeb" target="_blank">GitHub repo</a>,
                </div>
            </div>
            <div id="output-container">

                <div>
                    <h3>Opportunity Scores</h3>
                    <button id="export-table" class="hidden-button">Copy scores to clipboard</button>
                    <table id="oppscores-table">
                        <tr>
                            <th class="big-red">•</th>
                            <th>Outcome</th>
                            <th>Importance</th>
                            <th>Satisfaction</th>
                            <th>OppScore</th>
                        </tr>
                    </table>
                </div>

                <div>
                    <h3>Opportunity Landscape/Map</h3>
                    <button id="export-map" class="hidden-button">Export landscape/map to PNG</button>
                    <div id="map-area"></div>
                </div>

            </div>
            <h4>Output log:</h4>
            <div id="output-log">
            </div>
            <div id="footer">
                <a href="https://jpcarrascal.github.io" target="_blank">jpcarrascal.github.io</a>
            </div>
        </div>
        <script>
            window.onload = function() {
                var removeMissing = true;
                if (window.location.search.substr("keepMissing")) {
                    console.log("Rows with missing values will not be removed")
                    removeMissing = false;
                }
                function refresh(data) {
                    // set the dimensions and margins of the graph
                    var margin = {top: 10, right: 10, bottom: 50, left: 50},
                        width = 520 - margin.left - margin.right,
                        height = 470 - margin.top - margin.bottom;
                    
                    // append the svg object to the body of the page
                    var SVG = d3.select("#map-area")
                        .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform",
                                "translate(" + margin.left + "," + margin.top + ")");

                    SVG.append("rect")
                        .attr("width", "100%")
                        .attr("height", "100%")
                        .attr("fill", "white")
                        .attr("transform",
                                "translate(-" + margin.left + ",-" + margin.top + ")");
                    
                    // X scale and Axis
                    var x = d3.scaleLinear()
                        .domain([0, 10])         // This is the min and the max of the data: 0 to 100 if percentages
                        .range([0, width]);       // This is the corresponding value I want in Pixel
                    SVG
                        .append('g')
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));
                    
                    // X scale and Axis
                    var y = d3.scaleLinear()
                        .domain([0, 10])         // This is the min and the max of the data: 0 to 100 if percentages
                        .range([height, 0]);       // This is the corresponding value I want in Pixel
                    SVG
                        .append('g')
                        .call(d3.axisLeft(y));

                    SVG.append("line")
                        .attr("x1", x(10))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "black");
                    
                    SVG.append("line")
                        .attr("x1", x(0))
                        .attr("y1", y(10))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "black");

                    SVG.append("line")
                        .attr("x1", x(0))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "lightgrey");
                    
                    SVG.append("line")
                        .attr("x1", x(5))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(10))
                        .style("stroke", "lightgrey");

                    SVG.append("line")
                        .attr("x1", x(6))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(8))
                        .style("stroke-dasharray", ("3, 3"))
                        .style("stroke", "lightgrey");

                    SVG.append("line")
                        .attr("x1", x(7.5))
                        .attr("y1", y(0))
                        .attr("x2", x(10))
                        .attr("y2", y(5))
                        .style("stroke-dasharray", ("3, 3"))
                        .style("stroke", "lightgrey");
                    
                    SVG.append("text")     
                        .attr("x", function (d) { return x(3); } )
                        .attr("y", function (d) { return y(6); } )
                        .style("text-anchor", "middle")
                        .text("Overserved")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "17px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(4.1); } )
                        .attr("y", function (d) { return y(2); } )
                        .style("text-anchor", "middle")
                        .text("Appropriately Served")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "17px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(8); } )
                        .attr("y", function (d) { return y(2); } )
                        .style("text-anchor", "middle")
                        .text("Underserved")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "17px")
                        .style("fill", "lightgrey");
                    
                    // Underserved pportunity areas
                    SVG.append("text")     
                        .attr("x", function (d) { return x(8.7); } )
                        .attr("y", function (d) { return y(6.25); } )
                        .style("text-anchor", "middle")
                        .text("OppScore > 10")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(8.7); } )
                        .attr("y", function (d) { return y(5.95); } )
                        .style("text-anchor", "middle")
                        .text("Solid opportunity")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "11px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(8.8); } )
                        .attr("y", function (d) { return y(3.75); } )
                        .style("text-anchor", "middle")
                        .text("OppScore > 12")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(8.8); } )
                        .attr("y", function (d) { return y(3.45); } )
                        .style("text-anchor", "middle")
                        .text("Hight opportunity")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "11px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(8.9); } )
                        .attr("y", function (d) { return y(0.5); } )
                        .style("text-anchor", "middle")
                        .text("OppScore > 15")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "13px")
                        .style("fill", "lightgrey");

                    SVG.append("text")     
                        .attr("x", function (d) { return x(8.9); } )
                        .attr("y", function (d) { return y(0.2); } )
                        .style("text-anchor", "middle")
                        .text("Extreme opportunity")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "11px")
                        .style("fill", "lightgrey");

                    // Axis labels
                    SVG.append("text")     
                        .attr("x", function (d) { return x(-4.5); } )
                        .attr("y", function (d) { return y(10.6); } )
                        .style("text-anchor", "middle")
                        .text("Satisfaction")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "15px")
                        .style("fill", "grey")
                        .attr("transform", function(d) {
                                return "rotate(-90)" 
                        });

                    SVG.append("text")     
                        .attr("x", function (d) { return x(5); } )
                        .attr("y", function (d) { return y(-0.8); } )
                        .style("text-anchor", "middle")
                        .text("Importance")
                        .attr("font-family", "sans-serif")
                        .style("font-size", "15px")
                        .style("fill", "grey");

                    // points:
                    var points = SVG
                        .selectAll("whatever")
                        .data(data)
                        .enter()
                        .append("circle")
                        .attr("cx", function(d){ return x(d.x) })
                        .attr("cy", function(d){ return y(d.y) })
                        .style("fill", "red")
                        .attr("r", 5)

                    var labels = SVG
                        .selectAll("whatever")
                        .data(data)
                        .enter()
                        .append("text")
                        .attr("x", function (d) { return x(d.x)-8; } )
                        .attr("y", function (d) { return y(d.y)+3; } )
                        .text(function(d) { return d.index; })
                        .attr("font-family", "sans-serif")
                        .style("text-anchor", "end")
                        .attr("font-size", "12px")
                        .attr("cursor","default")
                        .attr("fill", "#666")

                }
                refresh([]);
                //generateRandomData();
                var sampleDataURL = "https://raw.githubusercontent.com/jpcarrascal/OppScoreWeb/main/sampledata.csv";
                var inputElement = document.querySelector("#input-data");
                readSampleData(sampleDataURL, document.querySelector("#input-data"));

                d3.select(".map-data").on('click', function(e){
                    //d3.selectAll("SVG > *").remove();
                    //document.querySelector("#input-data").value = "";
                    d3.select("#table-body").remove();
                    var inputdata = inputElement.value;
                    var newData = parsePastedData(inputdata);
                    if (newData.length > 0) {
                        document.querySelectorAll(".hidden-button").forEach( elem => { elem.style.visibility = "visible" });
                        status.textContent = "";
                        var oppScoreData = calculateOppScores(newData);
                        if (d3.select("svg")) d3.select("svg").remove();
                        asTable(oppScoreData);
                        refresh(oppScoreData);   
                    } else {
                        status.textContent = "Data missing or wrong format. Columns should be [outcome, importance, satisfaction]";
                    }
                });

                d3.select("#export-map").on('click', function(e){
                    saveSvgAsPng(document.querySelector("svg"), "OppMap.png");
                });

                d3.select("#export-table").on('click', function(e){
                    var tableElement = document.querySelector("#oppscores-table");
                    selectElementContents(tableElement);
                    document.execCommand('copy');
                    document.querySelector("#export-table").innerText = "Copied!";
                    setTimeout(() => {document.querySelector("#export-table").innerText = "Copy scores to clipboard"}, 3000);
                });

                function clearData() {
                    // TODO: Clear input file
                    d3.select("svg").remove();
                    d3.select("#table-body").remove();
                    document.querySelector("#input-data").value = "";
                    document.querySelector("#input-data").style.display = "block";
                    document.querySelectorAll(".hidden-button").forEach( elem => { elem.style.visibility = "hidden" });
                    status.textContent = "";
                    refresh([]);
                }

                d3.select("#clear").on('click', function(e){
                    document.querySelector("#file-selector").value = null;
                    clearData();
                });

                d3.select("#alt-open").on('click', function(e){
                    document.querySelector("#file-selector").value = null;
                    clearData();
                    document.querySelector("#alt-modal").style.display = "flex";
                    var surveyData = "https://raw.githubusercontent.com/jpcarrascal/OppScoreWeb/main/sampleSurveyData.csv";
                    fetch(surveyData)
                        .then(response => response.text())
                        .then(data => document.querySelector("#alt-data").value = data);
                });

                d3.select("#alt-close").on('click', function(e){
                    document.querySelector("#alt-modal").style.display = "none";
                });

                d3.select("#alt-clear").on('click', function(e){
                    document.querySelector("#alt-message").innerText = "";
                    document.querySelector("#alt-data").value = "";
                });

                d3.select("#alt-reformat").on('click', function(e){
                    var outElem = document.querySelector("#input-data");
                    var inData = document.querySelector("#alt-data").value;
                    try {
                        outElem.value = reformatData(inData);
                        setTimeout(function(){
                            document.querySelector("#alt-modal").style.display = "none";
                        }, 1
                        );
                        document.querySelector("#status").style.color = "forestgreen";
                        document.querySelector("#status").innerText = "Reformat sucessful! Transformed data is included below";
                    } catch(error) {
                        document.querySelector("#alt-message").innerText = error;
                    }
                });


                // Load sample data
                function readSampleData(sourceURL, destination) {
                    var result = Array();
                    d3.csv(sourceURL, function(data) {
                        for (var i = 0; i < data.length; i++) {
                            result[i] = {outcome: data[i].outcome, x: data[i].importance, y: data[i].satisfaction}
                            destination.value += (result[i].outcome + "\t"
                                                        + result[i].x + "\t" + result[i].y + "\n");
                        }
                        console.log("Read "+i+" rows from sample file");
                    });
                    return result;
                }

                // Read CSV file (borrowed from https://web.dev/read-files/)
                const status = document.getElementById('status');
                if (window.FileList && window.File && window.FileReader) {
                    document.getElementById('file-selector').addEventListener('change', event => {
                        clearData();
                        status.textContent = '';
                        const file = event.target.files[0];
                        if (!file.type) {
                            status.textContent = 'Error: The File.type property does not appear to be supported on this browser.';
                            return;
                        }
                        /*
                        if (!file.type.match('text/csv')) {
                            status.textContent = 'Error: The selected file does not appear to be a CSV file.'
                            return;
                        }
                        */
                        const reader = new FileReader();
                        reader.addEventListener('load', event => {
                            const data = d3.csvParse( event.target.result.replace(/\t/g,",") );
                            parseFileData(data);
                            //parsePastedData(event.target.result);
                        });
                        reader.readAsText(file,"UTF-8");
                    }); 
                }

                function parseFileData(data) {
                    outputLog("Parsing data from file...");
                    initialDataLength = data.length;
                    var newDisplayData = "";
                    var incompleteRows = 0;
                    var garbageRows = 0;
                    const cols = data.columns;
                    if(! (cols.includes("outcome") && cols.includes("importance") && cols.includes("satisfaction")) ) {
                        status.textContent = "Some columns not found! (they should be [outcome, importance, satisfaction])";
                        return;
                    }
                    console.log(data.columns);
                    for(var i = 0; i<data.length; i++) {
                        data[i].importance = parseInt(data[i].importance);
                        data[i].satisfaction = parseInt(data[i].satisfaction);
                        if( !Number.isInteger(data[i].importance) && !Number.isInteger(data[i].satisfaction) ) {
                            incompleteRows++;
                            outputLog("Malformed row "+i+" removed: " + data[i]);
                            data.splice(i,1);
                        }
                        else if( !Number.isInteger(data[i].importance) || !Number.isInteger(data[i].satisfaction) ) {
                            if(removeMissing) {
                                outputLog("Incomplete row "+i+" removed: " + data[i]);
                                data.splice(i,1);
                            }
                            incompleteRows++;
                        } else {
                            newDisplayData += data[i].outcome + "\t" + data[i].importance + "\t" + data[i].satisfaction + "\n";
                        }   
                    }
                    document.querySelector("#input-data").value = newDisplayData;
                    outputLog(initialDataLength + " input rows.");
                    outputLog(incompleteRows + " rows with missing values found.");
                    outputLog(garbageRows + " invalid rows found.");
                    if(removeMissing) outputLog(incompleteRows + " rows removed.");
                    outputLog(data.length + " rows used in calculation.");
                    return data;
                }

                function outputLog(line) {
                    console.log(line);
                    var log = document.getElementById("output-log");
                    log.innerText += line;
                    log.innerText += "\n";
                }

                function objJoin(obj) {
                    var str = "";
                    Object.values(obj).forEach(val => {
                        str += ", "+obj
                    });
                    return str;
                }

                function parsePastedData(inputdata) {
                    var newData = Array();
                    var newDisplayData = "";
                    var incompleteRows = 0;
                    var garbageRows = 0;
                    if(inputdata != "") {
                        var lines = inputdata.split(/\n/);
                        var initialDataLength = 0;
                        for(var i = 0; i<lines.length; i++) {
                            if(lines[i] != "") {
                                initialDataLength++;
                                var row = lines[i].split(separator);
                                row[1] = parseInt(row[1]);
                                row[2] = parseInt(row[2]);
                                if(row.length > 3) {
                                    outputLog("Row "+i+" removed (row too long): " + row);
                                    status.textContent = "Too many columns! (they should be [outcome, importance, satisfaction])"
                                    garbageRows++;
                                } else if(row.length == 3 && Number.isInteger(row[1]) && Number.isInteger(row[2]) ) {
                                    newData.push({outcome: row[0], x: row[1], y: row[2]});
                                    newDisplayData += row[0] + "\t" + row[1] + "\t" + row[2] + "\n";
                                } else if ( row.length == 3 && ( !Number.isInteger(row[1]) && !Number.isInteger(row[2]) ) ) {
                                    outputLog("Row "+i+" removed (non-numeric or missing values): " + row);
                                    garbageRows++;
                                } else if ( row.length == 3 && ( !Number.isInteger(row[1]) || !Number.isInteger(row[2]) ) ) {
                                    if(removeMissing) { // Remove rows with missing values:
                                        outputLog("Row "+i+" removed (missing values): " + row);
                                    } else {
                                        if(isNaN(row[1])) row[1] = "";
                                        if(isNaN(row[2])) row[2] = "";
                                        newData.push({outcome: row[0], x: row[1], y: row[2]});
                                        newDisplayData += row[0] + "\t" + row[1] + "\t" + row[2] + "\n";
                                        outputLog("Incomplete row "+i+" kept: " + row);
                                    }
                                    incompleteRows++;
                                } else {
                                    outputLog("Row "+i+" removed: " + row);
                                    garbageRows++;
                                } 
                            }
                        }
                    }
                    outputLog(initialDataLength + " input rows.");
                    outputLog(incompleteRows + " missing values found.");
                    outputLog(garbageRows + " rows with invalid values found.");
                    if(removeMissing) console.log(incompleteRows + " rows removed.");
                    outputLog(newData.length + " rows used in calculation.");
                    document.querySelector("#input-data").value = newDisplayData;
                    return newData;
                }

                function calculateOppScores(data) {
                    var outcomes = Array();
                    var OppScores = Array();
                    for(var i = 0; i<data.length; i++)
                        if(!outcomes.includes(data[i].outcome))
                            outcomes.push(data[i].outcome);
                    for(var i = 0; i<outcomes.length; i++) {
                        var thisOutcome = outcomes[i];
                        var sumImp = 0, sumSat = 0, countImp = 0, countSat = 0;
                        for(var j = 0; j<data.length; j++) {
                            var d = data[j];
                            if( d.outcome == thisOutcome ) {
                                if(d.x > 3)
                                    sumImp ++;
                                countImp ++;
                                if(d.y > 3)
                                    sumSat ++;
                                countSat ++;
                            }
                        }
                        var meanImp = roundTwo(10 * (sumImp / countImp));
                        var meanSat = roundTwo(10 * (sumSat / countSat));
                        var oppScore = meanImp + (Math.max(meanImp-meanSat,0));
                        oppScore = Math.round((oppScore + Number.EPSILON) * 100) / 100;
                        OppScores.push({ index: 0, outcome: thisOutcome, x: meanImp, y: meanSat, oppScore: oppScore});
                    }

                    OppScores.sort( compare );
                    for(var i=0; i<OppScores.length; i++) {
                        OppScores[i].index = i+1;
                    }

                    return OppScores;
                }

                function asTable(newData) {
                    var table = document.querySelector("#oppscores-table");
                    var tBody = document.createElement('tbody');
                    tBody.id = "table-body";

                    for(var i = 0; i<newData.length; i++) {
                        var row = tBody.insertRow();
                        var c0 = row.insertCell();
                        c0.innerHTML = newData[i].index;
                        var c1 = row.insertCell();
                        c1.innerHTML = newData[i].outcome;
                        var c2 = row.insertCell();
                        c2.innerHTML = newData[i].x;
                        c2.style.textAlign = "right";
                        var c3 = row.insertCell();
                        c3.innerHTML = newData[i].y;
                        c3.style.textAlign = "right";
                        var c4 = row.insertCell();
                        c4.innerHTML = newData[i].oppScore;
                        c4.style.textAlign = "right";
                    }
                    table.append(tBody);
                }

                var separator = "\t"; // separator = /[\t,\,]/;
                function reformatData(input) {
                    var data = input.split("\n");
                    if(!data[0].toLowerCase().includes("satisfaction") ||
                        !data[0].toLowerCase().includes("importance")) {
                        //alert("ERROR: Every column should be labeled as 'importance' or 'satisfaction'!!!");
                        throw("ERROR: Every column should be labeled as 'importance' or 'satisfaction'!!!");
                    }
                    var impsats = data[0].split(separator);
                    var numCols = impsats.length;
                    var outcomes = data[1].split(separator);
                    // Unique array elements, from: https://stackoverflow.com/questions/9229645/remove-duplicate-values-from-js-array
                    var uniqueOutcomes = outcomes.filter(function(item, pos, self) { return self.indexOf(item) == pos; });
                    var uniqueImpsat = impsats.filter(function(item, pos, self) { return self.indexOf(item) == pos; });
                    var numOutcomes = uniqueOutcomes.length;
                    console.log(uniqueOutcomes)
                    if(numCols % 2)
                        throw("ERROR: There must be an even number of columns! (importance + satisfaction)");
                    if(impsats.length != outcomes.length)
                    throw("ERROR: Looks like some columns are not correctly labeled...");
                    if(numOutcomes != outcomes.length/2)
                        throw("ERROR: There is a problem in the names of your outcomes!!!");
                    if(uniqueImpsat.length != 2)
                        throw("ERROR: There is a problem with the importance/satisfaction labels!!!");
                    if(countInArray(impsats,"importance") != countInArray(impsats,"satisfaction"))
                        throw("ERROR: importance and satisfaction counts do not match!!!");
                    var outputArray = new Array();
                    for(var i=2; i<data.length; i++) {
                        var dp = new Object();
                        //dp.p = "P"+(i-1);
                        var scores = data[i].split(separator);
                        for(o=0; o<uniqueOutcomes.length; o++) {
                            var currentOutcome = uniqueOutcomes[o];
                            for(var j=0; j<numCols; j++) {
                                if(outcomes[j] == currentOutcome) {
                                    dp.outcome = outcomes[j];
                                    if(impsats[j].toLowerCase() == "importance")
                                        dp.importance = scores[j];
                                    if(impsats[j].toLowerCase() == "satisfaction")
                                        dp.satisfaction = scores[j];
                                }
                            }
                            //var row = [dp.p, dp.outcome, dp.importance, dp.satisfaction].join("\t");
                            var row = [dp.outcome, dp.importance, dp.satisfaction].join("\t");
                            outputArray.push(row);
                        }
                    }
                    var output = outputArray.join("\n");                 
                    return output;
                }

                function countInArray(array, elem) {
                    let count = 0;
                    array.map((value) => {
                        if(value === elem) {
                            count = count + 1;
                        }
                    })
                    return count;
                }

                function generateRandomData() {
                    var result = Array();
                    var N = 8;
                    for(var i=0; i<64; i++) {
                        result[i] = {outcome:"_SampleOutcome_"+(Math.floor(i/N)+1), x: Math.round(Math.random()*4+1), y: Math.round(Math.random()*4+1)};
                        document.querySelector("#input-data").value += (result[i].outcome + "\t"
                                                        + result[i].x + "\t" + result[i].y + "\n");
                    }
                    return result;
                }

                function roundTwo(num) {
                    return Math.round(num * 100) / 100;
                }

                // Quick grab from: https://stackoverflow.com/questions/1129216/sort-array-of-objects-by-string-property-value
                function compare( a, b ) {
                    if ( a.oppScore > b.oppScore ){
                        return -1;
                    }
                    if ( a.oppScore < b.oppScore ){
                        return 1;
                    }
                    return 0;
                }
                // From: https://stackoverflow.com/questions/2044616/select-a-complete-table-with-javascript-to-be-copied-to-clipboard
                function selectElementContents(el) {
                    var body = document.body, range, sel;
                    if (document.createRange && window.getSelection) {
                        range = document.createRange();
                        sel = window.getSelection();
                        sel.removeAllRanges();
                        try {
                            range.selectNodeContents(el);
                            sel.addRange(range);
                        } catch (e) {
                            range.selectNode(el);
                            sel.addRange(range);
                        }
                    } else if (body.createTextRange) {
                        range = body.createTextRange();
                        range.moveToElementText(el);
                        range.select();
                    }
                }

            }
        </script>
    </body>
</html>
